# Release a Helm chart and publish to the repo index (GitHub Pages branch).
# One repo, multiple charts: charts/ has one dir per chart; gh-pages branch has index.yaml + .tgz files.
# Manual trigger only. Tag = <chart>-<version> (chart-specific).
# GitHub Pages: Settings → Pages → Deploy from a branch → gh-pages → / (root).
name: Release and publish Helm chart

on:
  workflow_dispatch:
    inputs:
      chart:
        description: 'Chart to release'
        required: true
        type: choice
        options:
          - devops-genie
          - devops-genie-sre-agent
        default: devops-genie
      bump:
        description: 'Bump version in Chart.yaml (patch/minor/major). Use "none" to keep current version.'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
        default: patch
      chart_version:
        description: 'Chart version (e.g. 0.1.0). Leave empty to use/bump version from Chart.yaml.'
        required: false
        type: string
      release_name:
        description: 'Release title (default: <chart>-<version>)'
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: "gh-pages"
  cancel-in-progress: false

jobs:
  release-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version in Chart.yaml
        if: github.event.inputs.chart_version == '' && github.event.inputs.bump != 'none'
        run: |
          CHART="${{ github.event.inputs.chart }}"
          CHART_PATH="charts/${CHART}/Chart.yaml"
          V=$(grep '^version:' "$CHART_PATH" | sed 's/.*version: *//' | tr -d '"\n\r ')
          IFS='.' read -r major minor patch <<< "$V"
          case "${{ github.event.inputs.bump }}" in
            patch) patch=$((patch + 1)) ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            major) major=$((major + 1)); minor=0; patch=0 ;;
            *) exit 1 ;;
          esac
          NEXT="${major}.${minor}.${patch}"
          sed -i "s/^version:.*/version: ${NEXT}/" "$CHART_PATH"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$CHART_PATH"
          git commit -m "chore(${CHART}): bump version to ${NEXT}"
          git push origin HEAD:main

      - name: Get chart version and tag
        id: chart-version
        run: |
          CHART="${{ github.event.inputs.chart }}"
          CHART_PATH="charts/${CHART}"
          if [[ ! -d "$CHART_PATH" ]]; then
            echo "::error::Chart not found: $CHART_PATH"
            exit 1
          fi
          if [[ -n "${{ github.event.inputs.chart_version }}" ]]; then
            V="${{ github.event.inputs.chart_version }}"
          else
            V=$(grep '^version:' "$CHART_PATH/Chart.yaml" | sed 's/.*version: *//' | tr -d '"\n\r ')
          fi
          echo "version=$V" >> $GITHUB_OUTPUT
          echo "tag=${CHART}-${V}" >> $GITHUB_OUTPUT
          echo "chart=$CHART" >> $GITHUB_OUTPUT

      - name: Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.14.0"

      - name: Package chart
        run: |
          CHART="${{ steps.chart-version.outputs.chart }}"
          V="${{ steps.chart-version.outputs.version }}"
          mkdir -p release
          helm package "charts/${CHART}" --version "$V"
          mv "${CHART}-${V}.tgz" release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.chart-version.outputs.tag }}
          name: ${{ github.event.inputs.release_name || steps.chart-version.outputs.tag }}
          files: release/*.tgz
          generate_release_notes: true

      - name: Prepare gh-pages branch
        run: |
          git fetch origin gh-pages 2>/dev/null || true
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git worktree add pages origin/gh-pages
          else
            git worktree add --detach pages
            (cd pages && git checkout --orphan gh-pages && git rm -rf . 2>/dev/null || true)
          fi

      - name: Update Helm repo index (gh-pages)
        run: |
          cp release/*.tgz pages/
          REPO_URL="https://devopsgenie-ai.github.io/devopsgenie-charts"
          if [ -s pages/index.yaml ] && grep -q '^entries:' pages/index.yaml; then
            helm repo index pages --merge pages/index.yaml --url "$REPO_URL"
          else
            helm repo index pages --url "$REPO_URL"
          fi

      - name: Add landing page
        run: |
          cat << 'HTMLEOF' | sed 's/^            //' > pages/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>DevOps Genie – Helm Charts</title>
          </head>
          <body style="font-family: system-ui, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6;">
            <h1>DevOps Genie</h1>
            <p>Helm charts for <a href="https://github.com/devopsgenie-ai">devopsgenie-ai</a>. Documentation at <a href="https://docs.devopsgenie.ai">docs.devopsgenie.ai</a>.</p>
            <h2>Helm repo</h2>
            <pre style="background: #f4f4f4; padding: 1rem; overflow-x: auto;"><code>helm repo add devopsgenie https://devopsgenie-ai.github.io/devopsgenie-charts/
            helm repo update
            helm search repo devopsgenie</code></pre>
            <h2>Charts</h2>
            <ul>
              <li><strong>devops-genie</strong> – AI assistant agent</li>
              <li><strong>devops-genie-sre-agent</strong> – SRE troubleshooting and alert investigation</li>
            </ul>
          </body>
          </html>
          HTMLEOF

      - name: Commit and push gh-pages
        run: |
          cd pages
          git add -A
          git add -f *.tgz
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if ! git diff --staged --quiet; then
            git commit -m "Publish ${{ steps.chart-version.outputs.chart }}-${{ steps.chart-version.outputs.version }}"
            git push origin HEAD:gh-pages
          fi
