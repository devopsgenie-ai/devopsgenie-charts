# Release a Helm chart and publish to the repo index (GitHub Pages).
# One repo, multiple charts (like https://github.com/grafana/k8s-monitoring-helm/tree/main/charts).
# Packages are hosted separately: each chart is a separate entry in the index; one workflow run releases one chart.
# Manual trigger only. Tag = <chart>-vX.Y.Z (e.g. devops-genie-v0.1.0, sre-agent-v0.1.0).
name: Release and publish Helm chart

on:
  workflow_dispatch:
    inputs:
      chart:
        description: 'Chart to release'
        required: true
        type: choice
        options:
          - devops-genie
          - devops-genie-sre-agent
        default: devops-genie
      chart_version:
        description: 'Chart version (e.g. 0.1.0). Leave empty to use version from Chart.yaml.'
        required: false
        type: string
      release_name:
        description: 'Release title (default: <chart>-v<version>)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  release-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get chart version and tag
        id: chart-version
        run: |
          CHART="${{ github.event.inputs.chart }}"
          CHART_PATH="charts/${CHART}"
          if [[ ! -d "$CHART_PATH" ]]; then
            echo "::error::Chart not found: $CHART_PATH"
            exit 1
          fi
          if [[ -n "${{ github.event.inputs.chart_version }}" ]]; then
            V="${{ github.event.inputs.chart_version }}"
          else
            V=$(grep '^version:' "$CHART_PATH/Chart.yaml" | sed 's/.*version: *//' | tr -d '"\n\r ')
          fi
          # Tag format: <chart>-vX.Y.Z (packages hosted separately per chart)
          case "$CHART" in
            devops-genie-sre-agent) TAG_PREFIX="sre-agent" ;;
            *) TAG_PREFIX="$CHART" ;;
          esac
          echo "version=$V" >> $GITHUB_OUTPUT
          echo "tag=${TAG_PREFIX}-v${V}" >> $GITHUB_OUTPUT
          echo "chart=$CHART" >> $GITHUB_OUTPUT

      - name: Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.14.0"

      - name: Package chart
        run: |
          CHART="${{ steps.chart-version.outputs.chart }}"
          V="${{ steps.chart-version.outputs.version }}"
          mkdir -p release
          helm package "charts/${CHART}" --version "$V"
          mv "${CHART}-${V}.tgz" release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.chart-version.outputs.tag }}
          name: ${{ github.event.inputs.release_name || steps.chart-version.outputs.tag }}
          files: release/*.tgz
          generate_release_notes: true

      - name: Chart index (merge with existing so both packages stay in one index)
        run: |
          curl -sfSL -o release/old-index.yaml "https://devopsgenie-ai.github.io/devopsgenie-charts/index.yaml" || rm -f release/old-index.yaml
          if [ -s release/old-index.yaml ] && grep -q '^entries:' release/old-index.yaml; then
            helm repo index release --merge release/old-index.yaml --url https://devopsgenie-ai.github.io/devopsgenie-charts
          else
            helm repo index release --url https://devopsgenie-ai.github.io/devopsgenie-charts
          fi
          rm -f release/old-index.yaml

      - name: Add landing page (list both charts)
        run: |
          cat << 'HTMLEOF' | sed 's/^            //' > release/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>DevOps Genie – Helm Charts</title>
          </head>
          <body style="font-family: system-ui, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6;">
            <h1>DevOps Genie</h1>
            <p>Helm charts for <a href="https://github.com/devopsgenie-ai">devopsgenie-ai</a>. Documentation at <a href="https://docs.devopsgenie.ai">docs.devopsgenie.ai</a>.</p>
            <h2>Helm repo</h2>
            <pre style="background: #f4f4f4; padding: 1rem; overflow-x: auto;"><code>helm repo add devopsgenie https://devopsgenie-ai.github.io/devopsgenie-charts/
            helm repo update
            helm search repo devopsgenie</code></pre>
            <h2>Charts (packages hosted separately)</h2>
            <ul>
              <li><strong>devops-genie</strong> – AI assistant agent</li>
              <li><strong>devops-genie-sre-agent</strong> – SRE troubleshooting and alert investigation</li>
            </ul>
          </body>
          </html>
          HTMLEOF

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: release

  deploy-pages:
    if: success()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: release-and-publish
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
